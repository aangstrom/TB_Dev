{
  "entityType" : "RULE_CHAIN",
  "entity" : {
    "additionalInfo" : {
      "description" : ""
    },
    "configuration" : null,
    "debugMode" : false,
    "externalId" : {
      "entityType" : "RULE_CHAIN",
      "id" : "2856ccc0-d476-11ed-9fb5-f96805f2c8b4"
    },
    "firstRuleNodeId" : {
      "entityType" : "RULE_NODE",
      "id" : "ee6efd61-d48a-11ed-9fb5-f96805f2c8b4"
    },
    "id" : {
      "entityType" : "RULE_CHAIN",
      "id" : "2856ccc0-d476-11ed-9fb5-f96805f2c8b4"
    },
    "name" : "Energy Calculation",
    "root" : false,
    "type" : "CORE"
  },
  "metaData" : {
    "connections" : [ {
      "fromIndex" : 0,
      "toIndex" : 1,
      "type" : "Failure"
    }, {
      "fromIndex" : 0,
      "toIndex" : 1,
      "type" : "Success"
    }, {
      "fromIndex" : 1,
      "toIndex" : 2,
      "type" : "Failure"
    }, {
      "fromIndex" : 1,
      "toIndex" : 2,
      "type" : "Success"
    }, {
      "fromIndex" : 2,
      "toIndex" : 3,
      "type" : "Failure"
    }, {
      "fromIndex" : 2,
      "toIndex" : 3,
      "type" : "Success"
    }, {
      "fromIndex" : 3,
      "toIndex" : 6,
      "type" : "Failure"
    }, {
      "fromIndex" : 3,
      "toIndex" : 6,
      "type" : "Success"
    }, {
      "fromIndex" : 4,
      "toIndex" : 5,
      "type" : "Failure"
    }, {
      "fromIndex" : 4,
      "toIndex" : 5,
      "type" : "Success"
    }, {
      "fromIndex" : 4,
      "toIndex" : 9,
      "type" : "Failure"
    }, {
      "fromIndex" : 4,
      "toIndex" : 9,
      "type" : "Success"
    }, {
      "fromIndex" : 4,
      "toIndex" : 12,
      "type" : "Failure"
    }, {
      "fromIndex" : 4,
      "toIndex" : 12,
      "type" : "Success"
    }, {
      "fromIndex" : 5,
      "toIndex" : 0,
      "type" : "Success"
    }, {
      "fromIndex" : 6,
      "toIndex" : 7,
      "type" : "Failure"
    }, {
      "fromIndex" : 6,
      "toIndex" : 7,
      "type" : "Success"
    }, {
      "fromIndex" : 7,
      "toIndex" : 8,
      "type" : "Success"
    }, {
      "fromIndex" : 9,
      "toIndex" : 10,
      "type" : "Success"
    }, {
      "fromIndex" : 12,
      "toIndex" : 10,
      "type" : "Success"
    }, {
      "fromIndex" : 12,
      "toIndex" : 11,
      "type" : "Success"
    } ],
    "firstNodeIndex" : 4,
    "nodes" : [ {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 376,
        "layoutY" : 328
      },
      "configuration" : {
        "tellFailureIfAbsent" : true,
        "fetchToData" : false,
        "clientAttributeNames" : [ ],
        "sharedAttributeNames" : [ ],
        "serverAttributeNames" : [ "orari_operativi" ],
        "latestTsKeyNames" : [ ],
        "getLatestValueWithTs" : false
      },
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "ee6eaf40-d48a-11ed-9fb5-f96805f2c8b4"
      },
      "name" : "Orari operativi",
      "ruleChainId" : null,
      "type" : "org.thingsboard.rule.engine.metadata.TbGetAttributesNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 704,
        "layoutY" : 329
      },
      "configuration" : {
        "tellFailureIfAbsent" : true,
        "fetchToData" : false,
        "clientAttributeNames" : [ ],
        "sharedAttributeNames" : [ ],
        "serverAttributeNames" : [ "orari_operativi_A" ],
        "latestTsKeyNames" : [ ],
        "getLatestValueWithTs" : false
      },
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "ee6ed650-d48a-11ed-9fb5-f96805f2c8b4"
      },
      "name" : "Orari operativi Fase A",
      "ruleChainId" : null,
      "type" : "org.thingsboard.rule.engine.metadata.TbGetAttributesNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 703,
        "layoutY" : 413
      },
      "configuration" : {
        "tellFailureIfAbsent" : true,
        "fetchToData" : false,
        "clientAttributeNames" : [ ],
        "sharedAttributeNames" : [ ],
        "serverAttributeNames" : [ "orari_operativi_B" ],
        "latestTsKeyNames" : [ ],
        "getLatestValueWithTs" : false
      },
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "ee6ed651-d48a-11ed-9fb5-f96805f2c8b4"
      },
      "name" : "Orari operativi Fase B",
      "ruleChainId" : null,
      "type" : "org.thingsboard.rule.engine.metadata.TbGetAttributesNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 704,
        "layoutY" : 498
      },
      "configuration" : {
        "tellFailureIfAbsent" : true,
        "fetchToData" : false,
        "clientAttributeNames" : [ ],
        "sharedAttributeNames" : [ ],
        "serverAttributeNames" : [ "orari_operativi_C" ],
        "latestTsKeyNames" : [ ],
        "getLatestValueWithTs" : false
      },
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "ee6efd60-d48a-11ed-9fb5-f96805f2c8b4"
      },
      "name" : "Orari operativi Fase C",
      "ruleChainId" : null,
      "type" : "org.thingsboard.rule.engine.metadata.TbGetAttributesNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 376,
        "layoutY" : 150
      },
      "configuration" : {
        "relationsQuery" : {
          "fetchLastLevelOnly" : false,
          "direction" : "TO",
          "maxLevel" : null,
          "filters" : [ {
            "relationType" : null,
            "entityTypes" : [ "DEVICE", "ASSET", "CUSTOMER" ]
          } ]
        },
        "telemetry" : false,
        "attrMapping" : {
          "F1" : "F1",
          "F2" : "F2",
          "F3" : "F3",
          "F23" : "F23"
        }
      },
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "ee6efd61-d48a-11ed-9fb5-f96805f2c8b4"
      },
      "name" : "Get F1/F2/F3/F23",
      "ruleChainId" : null,
      "type" : "org.thingsboard.rule.engine.metadata.TbGetRelatedAttributeNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 375,
        "layoutY" : 237
      },
      "configuration" : {
        "scriptLang" : "TBEL",
        "jsScript" : "return {msg: msg, metadata: metadata, msgType: msgType};",
        "tbelScript" : "var weekday=[\"domenica\",\"lunedi\",\"martedi\",\"mercoledi\",\"giovedi\",\"venerdi\",\"sabato\"];\nvar data=new Date();\n//var minute=new Date().getMinutes();\nvar ora=data.getHours()*100+data.getMinutes();\nvar day=weekday[new Date().getDay()];\n//prezzo per fasce;\nvar F1=parseFloat(metadata.F1);\nvar F2=parseFloat(metadata.F2);\nvar F3=parseFloat(metadata.F3);\nvar F23=parseFloat(metadata.F23);\n//orari F1\nvar inizioFascia1=800; //8:00\nvar fineFascia1=1900; //19:00\n//orari F2\nvar inizioFascia2_1=700; //7:00\nvar fineFascia2_1=800; //8:00\nvar inizioFascia2_2=1900; //19:00\nvar fineFascia2_2=2300; //23:00\n//orari F3\nvar inizioFascia3=2300; //00:00\nvar fineFascia3=700; //7:00\n//orari F23\nvar inizioFascia23=1900; //19:00\nvar fineFascia23=800; //8:00\n\n/** Calcoli **/\n//F1\nif((day!=\"domenica\" || day!=\"sabato\") && (ora>=inizioFascia1 && ora<fineFascia1)){\n    calcoloCosto(F1,\"F1\");\n}\n//Se F23 non è nullo\nif(F23!=null){\n    //Se corrisponde a F23\n    if(day==\"domenica\" || day==\"sabato\" || ((day!=\"domenica\" || day!=\"sabato\") && (ora>=inizioFascia23 || ora<fineFascia23))){\n        calcoloCosto(F23,\"F23\");\n    }\n}else{\n    //Se F2 non è nullo\n    if(F2!=null && ((day==\"sabato\" && (ora>=inizioFascia2_1 && ora<fineFascia2_2)) || ((day!=\"domenica\" || day!=\"sabato\") && ((ora>=inizioFascia2_1 && ora<fineFascia2_1) || (ora>=inizioFascia2_2 && ora<fineFascia2_2))))){\n        calcoloCosto(F2,\"F2\");\n    }\n    //Se F3 non è nullo\n    if(F3!=null && (day==\"domenica\" || (day!=\"domenica\" && ((ora>=inizioFascia3 || ora<fineFascia3))))){\n        calcoloCosto(F3,\"F3\");\n    }\n}\nreturn {msg: msg, metadata: metadata, msgType: msgType};\n\nfunction calcoloCosto(fascia,nomeFascia){\n    if(nomeFascia==\"F1\"){\n        if(msg.power>0){\n            msg.F1=msg.power*fascia;\n        }else if(msg.Phase_A_power>0){\n            msg.Phase_A_F1=msg.Phase_A_power*fascia;\n        }else if(msg.Phase_B_power>0){\n            msg.Phase_B_F1=msg.Phase_B_power*fascia;\n        }else if(msg.Phase_C_power>0){\n            msg.Phase_C_F1=msg.Phase_C_power*fascia;\n        }\n    }else if(nomeFascia==\"F2\"){\n        if(msg.power>0){\n            msg.F2=msg.power*fascia;\n        }else if(msg.Phase_A_power>0){\n            msg.Phase_A_F2=msg.Phase_A_power*fascia;\n        }else if(msg.Phase_B_power>0){\n            msg.Phase_B_F2=msg.Phase_B_power*fascia;\n        }else if(msg.Phase_C_power>0){\n            msg.Phase_C_F2=msg.Phase_C_power*fascia;\n        }\n    }else if(nomeFascia==\"F3\"){\n        if(msg.power>0){\n            msg.F3=msg.power*fascia;\n        }else if(msg.Phase_A_power>0){\n            msg.Phase_A_F3=msg.Phase_A_power*fascia;\n        }else if(msg.Phase_B_power>0){\n            msg.Phase_B_F3=msg.Phase_B_power*fascia;\n        }else if(msg.Phase_C_power>0){\n            msg.Phase_C_F3=msg.Phase_C_power*fascia;\n        }\n    }else if(nomeFascia==\"F23\"){\n        if(msg.power>0){\n            msg.F23=msg.power*fascia;\n        }else if(msg.Phase_A_power>0){\n            msg.Phase_A_F23=msg.Phase_A_power*fascia;\n        }else if(msg.Phase_B_power>0){\n            msg.Phase_B_F23=msg.Phase_B_power*fascia;\n        }else if(msg.Phase_C_power>0){\n            msg.Phase_C_F23=msg.Phase_C_power*fascia;\n        }\n    }\n}"
      },
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "ee6efd62-d48a-11ed-9fb5-f96805f2c8b4"
      },
      "name" : "Costo per Fascia",
      "ruleChainId" : null,
      "type" : "org.thingsboard.rule.engine.transform.TbTransformMsgNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 703,
        "layoutY" : 576
      },
      "configuration" : {
        "scriptLang" : "TBEL",
        "jsScript" : "return {msg: msg, metadata: metadata, msgType: msgType};",
        "tbelScript" : "var weekday=[\"domenica\",\"lunedi\",\"martedi\",\"mercoledi\",\"giovedi\",\"venerdi\",\"sabato\"];\nvar risultato=[\"non_op\"];\nvar hour=new Date().getHours();\nvar minute=new Date().getMinutes();\nvar day=weekday[new Date().getDay()];\nvar orari;\nif(msg.power!=null){orari=JSON.parse(metadata.ss_orari_operativi);}\nif(msg.Phase_A_power!=null){orari=JSON.parse(metadata.ss_orari_operativi_A);}\nif(msg.Phase_B_power!=null){orari=JSON.parse(metadata.ss_orari_operativi_B);}\nif(msg.Phase_C_power!=null){orari=JSON.parse(metadata.ss_orari_operativi_C);}\n\n\nif(orari.lunven!=null){\n    risultato=operativo(orari.lunven,hour,minute);\n}else{\n    if(day==\"lunedi\"){if(orari.lunedi!=null){risultato=operativo(orari.lunedi,hour,minute)}}\n    if(day==\"martedi\"){if(orari.martedi!=null){risultato=operativo(orari.martedi,hour,minute)}}\n    if(day==\"mercoledi\"){if(orari.mercoledi!=null){risultato=operativo(orari.mercoledi,hour,minute)}}\n    if(day==\"giovedi\"){if(orari.giovedi!=null){risultato=operativo(orari.giovedi,hour,minute)}}\n    if(day==\"venerdi\"){if(orari.venerdi!=null){risultato=operativo(orari.venerdi,hour,minute)}}\n    if(day==\"sabato\"){if(orari.sabato!=null){risultato=operativo(orari.sabato,hour,minute)}}\n    if(day==\"domenica\"){if(orari.domenica!=null){risultato=operativo(orari.domenica,hour,minute)}}\n}\n\nmsg.operativo=risultato;\nmetadata.ss_orari_operativi=null;\n\nreturn {msg: msg, metadata: metadata, msgType: msgType};\n\nfunction operativo(array,hour,minute){\n    var result=[5];\n    var currtime = hour * 100 + minute;\n    for(var i=0;i<array.length;i+=3){\n        var t=i+1;\n        var te=i+2;\n        var temp=array[i].split(\":\");\n        var temp2=array[t].split(\":\");\n        var temp3=array[te].split(\":\");\n        var temptime=parseInt(temp[0])*100+parseInt(temp[1]);\n        var temptime2=parseInt(temp2[0])*100+parseInt(temp2[1]);\n        if(currtime>=temptime && currtime<temptime2){\n            result=temp3[0];\n        }else{\n            result=\"non_op\";\n        }\n    }\n    return result;\n}"
      },
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "ee6f2470-d48a-11ed-9fb5-f96805f2c8b4"
      },
      "name" : "Test Orari operativi",
      "ruleChainId" : null,
      "type" : "org.thingsboard.rule.engine.transform.TbTransformMsgNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 1017,
        "layoutY" : 577
      },
      "configuration" : {
        "scriptLang" : "TBEL",
        "jsScript" : "function nextRelation(metadata, msg) {\n    return ['one','nine'];\n}\nif(msgType === 'POST_TELEMETRY_REQUEST') {\n    return ['two'];\n}\nreturn nextRelation(metadata, msg);",
        "tbelScript" : "if((JSON.stringify(msg) === '{}')==true) {\n    return ['Failed'];\n}else{\n    return ['Success'];\n}\nreturn nextRelation(metadata, msg);"
      },
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "ee6f2471-d48a-11ed-9fb5-f96805f2c8b4"
      },
      "name" : "Discard empty",
      "ruleChainId" : null,
      "type" : "org.thingsboard.rule.engine.filter.TbJsSwitchNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 1015,
        "layoutY" : 650
      },
      "configuration" : {
        "defaultTTL" : 0,
        "skipLatestPersistence" : false,
        "useServerTs" : false
      },
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "ee6f2472-d48a-11ed-9fb5-f96805f2c8b4"
      },
      "name" : "Save Timeseries",
      "ruleChainId" : null,
      "type" : "org.thingsboard.rule.engine.telemetry.TbMsgTimeseriesNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 719,
        "layoutY" : 118
      },
      "configuration" : {
        "inputValueKey" : "power",
        "outputValueKey" : "sumPower",
        "mathFunction" : "SUM",
        "aggIntervalType" : "HOUR",
        "timeZoneId" : "Europe/Rome",
        "aggIntervalValue" : 1,
        "aggIntervalTimeUnit" : "HOURS",
        "intervalPersistencePolicy" : "ON_EACH_CHECK_AFTER_INTERVAL_END",
        "outMsgType" : "POST_TELEMETRY_REQUEST",
        "intervalCheckValue" : 1,
        "intervalCheckTimeUnit" : "MINUTES",
        "statePersistencePolicy" : "PERIODICALLY",
        "statePersistenceValue" : 1,
        "statePersistenceTimeUnit" : "MINUTES",
        "autoCreateIntervals" : false,
        "periodValue" : 1,
        "periodTimeUnit" : "HOURS",
        "parentEntitiesQuery" : {
          "type" : "group",
          "entityGroupId" : null
        },
        "queueName" : "Main"
      },
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "10609440-ddd9-11ed-9fb5-f96805f2c8b4"
      },
      "name" : "Test Stream",
      "ruleChainId" : null,
      "type" : "org.thingsboard.rule.engine.analytics.incoming.TbSimpleAggMsgNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 1119,
        "layoutY" : 119
      },
      "configuration" : {
        "scope" : "SERVER_SCOPE",
        "notifyDevice" : false,
        "sendAttributesUpdatedNotification" : false
      },
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "b579cbd0-dde9-11ed-9fb5-f96805f2c8b4"
      },
      "name" : "Save Attributes",
      "ruleChainId" : null,
      "type" : "org.thingsboard.rule.engine.telemetry.TbMsgAttributesNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 1124,
        "layoutY" : 179
      },
      "configuration" : {
        "scriptLang" : "TBEL",
        "jsScript" : "return '\\nIncoming message:\\n' + JSON.stringify(msg) + '\\nIncoming metadata:\\n' + JSON.stringify(metadata);",
        "tbelScript" : "return '\\nIncoming message:\\n' + JSON.stringify(msg) + '\\nIncoming metadata:\\n' + JSON.stringify(metadata);"
      },
      "createdTime" : 0,
      "debugMode" : true,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "b57a8f20-dde9-11ed-9fb5-f96805f2c8b4"
      },
      "name" : "Test",
      "ruleChainId" : null,
      "type" : "org.thingsboard.rule.engine.action.TbLogNode"
    }, {
      "additionalInfo" : {
        "description" : "",
        "layoutX" : 718,
        "layoutY" : 183
      },
      "configuration" : {
        "inputValueKey" : "power",
        "outputValueKey" : "sumDayPower",
        "mathFunction" : "SUM",
        "aggIntervalType" : "DAY",
        "timeZoneId" : "Europe/Rome",
        "aggIntervalValue" : 1,
        "aggIntervalTimeUnit" : "HOURS",
        "intervalPersistencePolicy" : "ON_EACH_CHECK_AFTER_INTERVAL_END",
        "outMsgType" : "POST_TELEMETRY_REQUEST",
        "intervalCheckValue" : 1,
        "intervalCheckTimeUnit" : "MINUTES",
        "statePersistencePolicy" : "PERIODICALLY",
        "statePersistenceValue" : 1,
        "statePersistenceTimeUnit" : "MINUTES",
        "autoCreateIntervals" : false,
        "periodValue" : 5,
        "periodTimeUnit" : "MINUTES",
        "parentEntitiesQuery" : {
          "type" : "group",
          "entityGroupId" : null
        },
        "queueName" : "Main"
      },
      "createdTime" : 0,
      "debugMode" : false,
      "externalId" : null,
      "id" : {
        "entityType" : "RULE_NODE",
        "id" : "b0e65140-ddfa-11ed-9fb5-f96805f2c8b4"
      },
      "name" : "Test 2",
      "ruleChainId" : null,
      "type" : "org.thingsboard.rule.engine.analytics.incoming.TbSimpleAggMsgNode"
    } ],
    "ruleChainConnections" : null
  },
  "relations" : [ ],
  "attributes" : {
    "SERVER_SCOPE" : [ ]
  }
}